<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Pizza & Taste</title>
    
    <style>
        :root {
            --primary-color: #b71c1c;
            --secondary-color: #2e7d32;
            --bg-color: #f0f2f5;
            --text-color: #333;
            --white: #ffffff;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); }

        /* --- Header --- */
        header { background-color: var(--primary-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .brand { display: flex; align-items: center; gap: 15px; color: white; font-size: 22px; font-weight: bold; text-decoration: none; }
        .logo-img { width: 45px; height: 45px; object-fit: cover; border-radius: 8px; background: white; border: 2px solid rgba(255,255,255,0.2); }
        .header-actions { display: flex; gap: 15px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-novo { background-color: var(--secondary-color); color: white; }
        .btn-sair { background-color: white; color: var(--primary-color); }

        /* --- Layout --- */
        main { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); }
        .card h3 { margin: 0; font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .card p { margin: 10px 0 0; font-size: 32px; font-weight: 800; }

        /* --- Tabelas --- */
        .section-container { background: var(--white); border-radius: 12px; padding: 25px; margin-bottom: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .section-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        th { background-color: #f8f9fa; color: #666; text-transform: uppercase; font-size: 12px; }
        tr:hover { background-color: #fcfcfc; }
        
        .thumb-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
        .no-img { width: 50px; height: 50px; background: #eee; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 10px; font-weight: bold; color: #aaa; border: 1px dashed #ccc; }

        /* Botões de Ação na Tabela */
        .btn-action { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .btn-edit { background-color: #f57c00; }
        .btn-del { background-color: #d32f2f; }
        .btn-view { background-color: #1976d2; }
        .btn-action:hover { opacity: 0.9; }

        /* Badges de Tipo */
        .badge-delivery { color: #2e7d32; background: #e8f5e9; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .badge-retirada { color: #f57c00; background: #fff3e0; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .btn-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #555; text-transform: uppercase; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .btn-block { width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
        .preview-box { text-align: center; margin-top: 10px; background: #fafafa; padding: 10px; border-radius: 8px; border: 2px dashed #ddd; }
        .preview-img { max-width: 100%; max-height: 150px; border-radius: 8px; display: none; margin: 0 auto; }
    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="img/logo.png" alt="Admin" class="logo-img" onerror="this.style.display='none'">
            <span>Pizza & Taste <small style="font-size:12px; opacity:0.8;">ADMIN</small></span>
        </a>
        <div class="header-actions">
            <button class="btn btn-novo" onclick="abrirModalNovo()">+ Novo Produto</button>
            <button class="btn btn-sair" onclick="logout()">Sair</button>
        </div>
    </header>

    <main>
        <div class="dashboard-grid">
            <div class="card"><h3>Vendas Hoje</h3><p id="vendas-hoje">R$ 0,00</p></div>
            <div class="card" style="border-left-color: var(--secondary-color);"><h3>Faturamento Mês</h3><p id="vendas-mes">R$ 0,00</p></div>
            <div class="card" style="border-left-color: #f57c00;"><h3>Produtos Ativos</h3><p id="total-produtos">Loading...</p></div>
        </div>

        <div class="section-container">
            <div class="section-header">
                <div class="section-title">Gerenciar Pedidos</div>
                <button class="btn" onclick="carregarDados()" style="background:#eee;">Atualizar Lista</button>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Endereço / Tipo</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th style="text-align: right;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-pedidos">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">Carregando pedidos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section-container">
            <div class="section-header">
                <div class="section-title">Cardápio Digital</div>
                <button class="btn" onclick="carregarDados()" style="background:#eee;">Atualizar Lista</button>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th width="60">Foto</th>
                            <th>Nome / Descrição</th>
                            <th>Categoria</th>
                            <th>Preços</th>
                            <th style="text-align: right;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-produtos">
                        <tr><td colspan="5" style="text-align:center; padding:20px;">Carregando produtos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="modalProduto">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo" style="margin:0;">Novo Produto</h3>
                <button class="btn-close" onclick="fecharModal()">&times;</button>
            </div>
            
            <form onsubmit="salvarProduto(event)">
                <input type="hidden" id="prodId">

                <div class="form-group">
                    <label>Nome do Item</label>
                    <input type="text" class="form-control" id="prodNome" required placeholder="Ex: Pizza Calabresa">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Categoria</label>
                        <select class="form-control" id="prodTipo" required onchange="toggleTamanhos()">
                            <option value="Pizza Salgada">Pizza Salgada</option>
                            <option value="Pizza Doce">Pizza Doce</option>
                            <option value="Refrigerante">Refrigerante</option>
                            <option value="Suco">Suco</option>
                            <option value="Sobremesas">Sobremesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preço Principal (R$)</label>
                        <input type="number" class="form-control" id="prodPreco" step="0.01" required placeholder="0.00">
                    </div>
                </div>

                <div id="area-tamanhos" style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px;">
                    <label style="color:var(--primary-color); border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px;">Configuração de Tamanhos</label>
                    
                    <div style="display:flex; align-items:center; margin-bottom:10px; gap:10px;">
                        <input type="checkbox" id="checkGrande" checked>
                        <span style="font-size:14px; width:100px;">Grande</span>
                        <small style="color:#888;">(Usa o preço principal acima)</small>
                    </div>

                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="checkBroto">
                        <span style="font-size:14px; width:100px;">Broto</span>
                        <input type="number" class="form-control" id="prodPrecoBroto" step="0.01" placeholder="R$ Preço Broto" style="width: 120px;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descrição / Ingredientes</label>
                    <input type="text" class="form-control" id="prodDesc" placeholder="Ex: Molho, mussarela, calabresa...">
                </div>

                <div class="form-group">
                    <label>Imagem do Produto</label>
                    <input type="file" class="form-control" id="prodImagemInput" accept="image/*" onchange="previewImage(this)">
                    <div class="preview-box">
                        <img id="previewImgElement" class="preview-img">
                        <span id="previewText" style="font-size:12px; color:#999;">Nenhuma imagem selecionada</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-novo btn-block">Salvar Dados</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:4000';
        let listaGlobalProdutos = [];

        // --- AUTH ---
        const token = localStorage.getItem('tokenProprietario');
        if (!token) window.location.href = 'login-proprietario.html';
        function logout() { localStorage.removeItem('tokenProprietario'); window.location.href = 'index.html'; }

        // --- INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            carregarDados();
            setInterval(carregarDados, 15000);
        });

        // --- FETCH DATA ---
        async function carregarDados() {
            try {
                const resResumo = await fetch(`${API_URL}/pedidos/resumo`);
                const resumo = await resResumo.json();
                document.getElementById('vendas-hoje').innerText = `R$ ${resumo.hoje.total ? resumo.hoje.total.toFixed(2) : '0.00'}`;
                document.getElementById('vendas-mes').innerText = `R$ ${resumo.mes.total ? resumo.mes.total.toFixed(2) : '0.00'}`;

                const resProd = await fetch(`${API_URL}/produtos`);
                listaGlobalProdutos = await resProd.json();
                renderizarProdutos(listaGlobalProdutos);
                document.getElementById('total-produtos').innerText = listaGlobalProdutos.length;

                const resPed = await fetch(`${API_URL}/pedidos`);
                const pedidos = await resPed.json();
                renderizarPedidos(pedidos);

            } catch (error) {
                console.error("Erro ao carregar:", error);
            }
        }

        // --- RENDERS ---
        function renderizarProdutos(produtos) {
            const tbody = document.getElementById('tabela-produtos');
            tbody.innerHTML = '';

            if (!produtos || produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">Nenhum produto cadastrado.</td></tr>';
                return;
            }

            produtos.forEach(p => {
                const imgHtml = p.imagem 
                    ? `<img src="${p.imagem}" class="thumb-img">` 
                    : `<div class="no-img">SEM FOTO</div>`;
                
                let precosHtml = `<div><strong>G:</strong> R$ ${p.preco.toFixed(2)}</div>`;
                if(p.tem_broto) {
                    precosHtml += `<div style="color:#e65100; font-size:12px;"><strong>B:</strong> R$ ${p.preco_broto ? p.preco_broto.toFixed(2) : '0.00'}</div>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${imgHtml}</td>
                        <td>
                            <strong>${p.nome}</strong>
                            <div style="font-size:12px; color:#888; max-width:250px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${p.descricao || 'Sem descrição'}
                            </div>
                        </td>
                        <td><span style="background:#eee; padding:3px 8px; border-radius:10px; font-size:11px;">${p.tipo_produto}</span></td>
                        <td>${precosHtml}</td>
                        <td style="text-align: right;">
                            <button class="btn-action btn-edit" onclick="abrirModalEdicao(${p.cod_produto})">Editar</button>
                            <button class="btn-action btn-del" onclick="excluirProduto(${p.cod_produto})">Excluir</button>
                        </td>
                    </tr>`;
            });
        }

        function renderizarPedidos(pedidos) {
            const tbody = document.getElementById('tabela-pedidos');
            tbody.innerHTML = '';

            if (!pedidos || pedidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#888;">Nenhum pedido por enquanto.</td></tr>';
                return;
            }

            pedidos.slice(0, 20).forEach(p => {
                let bg = '#e3f2fd', color = '#1565c0';
                if(p.status === 'Em Preparo') { bg = '#fff3e0'; color = '#e65100'; }
                if(p.status === 'Saiu para Entrega') { bg = '#e8f5e9'; color = '#2e7d32'; }
                if(p.status === 'Concluído') { bg = '#f1f8e9'; color = '#33691e'; }
                if(p.status === 'Cancelado') { bg = '#ffebee'; color = '#c62828'; }

                const enderecoShow = p.tipo_entrega === 'Entrega' 
                    ? `<span class="badge-delivery">[Delivery]</span> ${p.endereco_entrega}` 
                    : `<span class="badge-retirada">[Retirada]</span> Balcão`;

                tbody.innerHTML += `
                    <tr>
                        <td>#${p.cod_pedido}</td>
                        <td><strong>${p.username_cliente}</strong><br><small style="color:#999">${new Date(p.data_pedido).toLocaleTimeString().slice(0,5)}</small></td>
                        <td style="font-size:13px; color:#555;">${enderecoShow}</td>
                        <td>
                            <select onchange="mudarStatus(${p.cod_pedido}, this.value)" style="background:${bg}; color:${color}; border:none; padding:5px; border-radius:4px; font-weight:bold; cursor:pointer;">
                                <option value="Aberto" ${p.status==='Aberto'?'selected':''}>Aberto</option>
                                <option value="Em Preparo" ${p.status==='Em Preparo'?'selected':''}>Em Preparo</option>
                                <option value="Saiu para Entrega" ${p.status==='Saiu para Entrega'?'selected':''}>Saiu p/ Entrega</option>
                                <option value="Concluído" ${p.status==='Concluído'?'selected':''}>Concluído</option>
                                <option value="Cancelado" ${p.status==='Cancelado'?'selected':''}>Cancelado</option>
                            </select>
                        </td>
                        <td style="font-weight:bold;">R$ ${p.preco_total.toFixed(2)}</td>
                        <td style="text-align:right;">
                            <button class="btn-action btn-view" onclick="alert('Em breve: Exibir Itens do Pedido #${p.cod_pedido}')">Ver Itens</button>
                        </td>
                    </tr>`;
            });
        }

        // --- AÇÕES ---
        async function salvarProduto(e) {
            e.preventDefault();
            const id = document.getElementById('prodId').value;
            
            const payload = {
                nome: document.getElementById('prodNome').value,
                tipo_produto: document.getElementById('prodTipo').value,
                descricao: document.getElementById('prodDesc').value,
                preco: parseFloat(document.getElementById('prodPreco').value) || 0,
                tem_grande: document.getElementById('checkGrande').checked,
                tem_broto: document.getElementById('checkBroto').checked,
                preco_broto: parseFloat(document.getElementById('prodPrecoBroto').value) || 0
            };

            const fileInput = document.getElementById('prodImagemInput');
            if(fileInput.files.length > 0) {
                payload.imagem = await converterBase64(fileInput.files[0]);
            }

            const url = id ? `${API_URL}/produtos/${id}` : `${API_URL}/produtos`;
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                fecharModal();
                carregarDados();
                alert("Salvo com sucesso!");
            } catch(e) {
                alert("Erro ao salvar.");
            }
        }

        async function mudarStatus(id, novoStatus) {
            try {
                await fetch(`${API_URL}/pedidos/${id}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: novoStatus })
                });
                carregarDados();
            } catch(e) { alert("Erro ao mudar status"); }
        }

        async function excluirProduto(id) {
            if(confirm("Tem certeza que deseja excluir?")) {
                await fetch(`${API_URL}/produtos/${id}`, { method: 'DELETE' });
                carregarDados();
            }
        }

        // --- MODAL ---
        function abrirModalNovo() {
            document.getElementById('modalTitulo').innerText = "Novo Produto";
            document.getElementById('prodId').value = "";
            document.querySelector('form').reset();
            document.getElementById('previewImgElement').style.display = 'none';
            document.getElementById('previewText').style.display = 'block';
            toggleTamanhos();
            document.getElementById('modalProduto').style.display = 'flex';
        }

        function abrirModalEdicao(id) {
            const p = listaGlobalProdutos.find(x => x.cod_produto === id);
            if(!p) return;

            document.getElementById('modalTitulo').innerText = "Editar Produto";
            document.getElementById('prodId').value = p.cod_produto;
            document.getElementById('prodNome').value = p.nome;
            document.getElementById('prodTipo').value = p.tipo_produto;
            document.getElementById('prodDesc').value = p.descricao || '';
            document.getElementById('prodPreco').value = p.preco;

            document.getElementById('checkGrande').checked = p.tem_grande;
            document.getElementById('checkBroto').checked = p.tem_broto;
            document.getElementById('prodPrecoBroto').value = p.preco_broto || '';

            const imgEl = document.getElementById('previewImgElement');
            const txtEl = document.getElementById('previewText');
            if(p.imagem) {
                imgEl.src = p.imagem; imgEl.style.display='block'; txtEl.style.display='none';
            } else {
                imgEl.style.display='none'; txtEl.style.display='block';
            }

            toggleTamanhos();
            document.getElementById('modalProduto').style.display = 'flex';
        }

        function fecharModal() { document.getElementById('modalProduto').style.display = 'none'; }

        function toggleTamanhos() {
            const tipo = document.getElementById('prodTipo').value;
            const area = document.getElementById('area-tamanhos');
            
            if(tipo.includes('Pizza')) {
                area.style.opacity = "1";
                area.style.pointerEvents = "auto";
            } else {
                area.style.opacity = "0.5";
                area.style.pointerEvents = "none";
                document.getElementById('checkGrande').checked = true;
                document.getElementById('checkBroto').checked = false;
            }
        }

        function previewImage(input) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    document.getElementById('previewImgElement').src = e.target.result;
                    document.getElementById('previewImgElement').style.display = 'block';
                    document.getElementById('previewText').style.display = 'none';
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function converterBase64(file) {
            return new Promise((res, rej) => {
                const r = new FileReader();
                r.readAsDataURL(file);
                r.onload = () => res(r.result);
                r.onerror = e => rej(e);
            });
        }
    </script>
</body>
</html>